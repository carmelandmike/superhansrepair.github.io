<script type = "application/javascript">

var FUDGE = 0.8; //(how far towards bottom right corner of the part do we draw the circle)
var ANIMATION_RADIUS = 20 //(this is the animation start radius)
var NORMAL_RADIUS = 3 //(standard radius)
var OVER_RADIUS = 4 //(during hover)
var COLOUR = "red" // (circle colour)
var OPACITY = 0.6 // (how solid the circle fill is)
var ENTRY_ANIMATION //tracks to see if in progress
var ENTRY_TIMEOUT = 2000 //in milliseconds

var elementsOfInterest = [
  {
    id : "path3427_3_",
    name : "wheel"
  },
  {
    id : "path3267_3_",
    name : "wing-mirror"
  },
  {
    id : "path4289_3_",
    name : "exhaust"
  },
  {
    id : "path3486_8_",
    name : "headlight"
  }
]

function attachHandlerTo({id, name}){
  console.log(id,name)
  var element = document.getElementById(id)
  if(null!== element){
      //Register animation trigger
      var body = d3.select("body")
      body.on("mousemove",entryAnimation)

      //Set a timeout in case they don't move their mousemove
      setTimeout(entryAnimation,ENTRY_TIMEOUT)

      //Find superhans
      var svg = d3.select("svg")

      //Find the referenced "part" and extent
      var part = d3.select("#"+id);
      var boundingBox = part.node().getBBox()

      //Create a bounding group to move our circle and + to
      var additions = svg
      .append("g")
      .attr("transform", "translate("+
        (boundingBox.x+boundingBox.width*FUDGE)+","+
        (boundingBox.y+boundingBox.height*FUDGE)+")"
      )

      //Add the circle
      var circle = additions
      .append("circle")
      .attr("class","circleOfInterest")
      .style("fill",COLOUR)
      .attr("r",ANIMATION_RADIUS)
      .attr("opacity",0)

      //Add the plus sign
      var plus = additions
      .append("text")
      .attr("class","plusSign")
      .style("fill","white")
      .attr("text-anchor","middle")
      .attr("font-size","0.3em")
      .attr("dy","0.3em")
      .attr("opacity",0)
      .text("+")
      .attr("transform","rotate("+900+")")

      //Append a transparent box to capture mouse over event
      var mouseCatcher = additions
      .append("rect")
      .attr("x",-OVER_RADIUS)
      .attr("y",-OVER_RADIUS)
      .attr("width",2*OVER_RADIUS)
      .attr("height",2*OVER_RADIUS)
      .attr("opacity",0)
      .style("cursor","pointer")

      var over = getOverListener(true,{circle,plus});
      var out = getOverListener(false,{circle,plus});
      var click = getClickListener(name)

      mouseCatcher
      .on("mouseover",over)
      .on("mouseout",out)
      .on("click",click)

  } else {
    console.error("I couldn't find",name,"using",id,"... Sad")
  }
}

function getClickListener(name){
  if(!handleClickFor || typeof handleClickFor !== 'function'){
    console.log("There's no click handler 'handleClickFor' declared in scripts. Sad")
    return ()=>{}
  } else {
    return ()=>{
      handleClickFor(name)
    }
  }
}


function getOverListener(over,bits){
  return (over ?
  function (){
    bits.circle
    .attr("r",OVER_RADIUS)
    .attr("opacity",1)
  } :
  function (){
    bits.circle
    .transition()
    .duration(250)
    .attr("r",3)
    .attr("opacity",OPACITY)
 })
}

elementsOfInterest.forEach((element)=>{
  attachHandlerTo(element)
})

function entryAnimation(){
  if(!ENTRY_ANIMATION){
    ENTRY_ANIMATION = true
    d3.selectAll(".circleOfInterest")
    .transition()
    .duration(750)
    .ease(d3.easeLinear)
    .attr("opacity",OPACITY)
    .attr("r",NORMAL_RADIUS)

    d3.selectAll(".plusSign")
    .transition()
    .duration(750)
    .ease(d3.easeLinear)
    .attr("opacity",1)
    .attr("transform","rotate("+0+")")

    d3.select("svg")
    .on("mousemove",()=>{})
  }
}

</script>
